name: Requirements Audit

on:
  # Run on a schedule (weekly on Sundays at 6am UTC)
  schedule:
    - cron: '0 6 * * 0'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual audit run'

# Ensure only one audit runs at a time
concurrency:
  group: requirements-audit
  cancel-in-progress: false

jobs:
  audit:
    name: Audit Requirements
    runs-on: ubuntu-latest
    
    # Required for creating PRs
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run requirements audit
        id: audit
        run: |
          # Run the audit script
          set +e
          node .github/scripts/audit-requirements.mjs
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 42 ]; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes needed"
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          else
            echo "Audit script failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi
      
      - name: Check for changes
        id: check_changes
        if: steps.audit.outputs.changes == 'true'
        run: |
          if git diff --quiet IMPLEMENTATION_PLAN.md; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "### Changes to IMPLEMENTATION_PLAN.md" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            git diff --no-color IMPLEMENTATION_PLAN.md | head -100 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Create or update PR
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create branch name with timestamp
          BRANCH_NAME="audit/requirements-$(date +%Y%m%d-%H%M%S)"
          
          # Check if there's an existing audit PR
          EXISTING_PR=$(gh pr list --search "Automated Requirements Audit" --state open --json number --jq '.[0].number // empty')
          
          if [ -n "$EXISTING_PR" ]; then
            # Update existing PR
            BRANCH_NAME=$(gh pr view $EXISTING_PR --json headRefName --jq '.headRefName')
            git checkout -B "$BRANCH_NAME"
            git add IMPLEMENTATION_PLAN.md
            git commit -m "chore: update requirements audit results
            
            Automated audit run on $(date -u +%Y-%m-%dT%H:%M:%SZ)
            
            Trigger: ${{ github.event_name }}
            ${{ github.event.inputs.reason || 'Scheduled/automated' }}"
            git push -f origin "$BRANCH_NAME"
            
            echo "Updated existing PR #$EXISTING_PR"
          else
            # Create new branch and PR
            git checkout -b "$BRANCH_NAME"
            git add IMPLEMENTATION_PLAN.md
            git commit -m "chore: update requirements audit results
            
            Automated audit run on $(date -u +%Y-%m-%dT%H:%M:%SZ)
            
            Trigger: ${{ github.event_name }}
            ${{ github.event.inputs.reason || 'Scheduled/automated' }}"
            git push origin "$BRANCH_NAME"
            
            # Create PR
            gh pr create \
              --title "Automated Requirements Audit" \
              --body "## ðŸ¤– Automated Requirements Audit

This PR was automatically generated by the requirements audit workflow.

### What this does
- Scans all \`/docs/*.md\` and root \`*.md\` files for requirements
- Compares checkbox markers and task IDs with \`IMPLEMENTATION_PLAN.md\`
- Updates the audit summary section with findings
- Records npm check results (lint status)

### Review checklist
- [ ] Verify the audit summary is accurate
- [ ] Check that no requirements were removed
- [ ] Review any issues flagged

### Trigger
- **Event:** ${{ github.event_name }}
- **Reason:** ${{ github.event.inputs.reason || 'Scheduled/automated' }}
- **Run:** [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

---
*This PR will be automatically updated if more changes are detected.*" \
              --base main \
              --head "$BRANCH_NAME" \
              --label "automated,documentation"
            
            echo "Created new PR"
          fi
      
      - name: Summary
        run: |
          echo "## Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Changes detected and PR created/updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes needed" >> $GITHUB_STEP_SUMMARY
          fi
